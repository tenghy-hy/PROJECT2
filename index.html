<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ä½œé …ç›® 02ï¼šä½œæ¥­æº–å‚™ - æ¸¬é©—ç³»çµ±</title>
    <style>
        :root { 
            --main: #0984e3; 
            --bg: #f0f2f5; 
            --win: #00b894; 
            --lose: #d63031; 
            --warning: #fdcb6e;
            --text: #2d3436;
        }
        body { 
            font-family: "Microsoft JhengHei", "PingFang TC", sans-serif; 
            background: var(--bg); 
            display: flex; 
            justify-content: center; 
            align-items: flex-start; 
            min-height: 100vh; 
            margin: 0; 
            padding: 20px 0;
        }
        #game-box { 
            background: white; 
            width: 95%; 
            max-width: 650px; 
            padding: 25px; 
            border-radius: 15px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            text-align: center; 
        }
        
        /* é ‚éƒ¨è³‡è¨Šæ¬„ */
        .info-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-weight: bold;
        }
        #timer-text { color: var(--lose); font-size: 1.1em; }

        .rule-box { 
            background: #fff9db; 
            border: 1px solid #ffe066; 
            padding: 15px; 
            border-radius: 10px; 
            text-align: left; 
            font-size: 0.95em; 
            margin-bottom: 20px; 
            line-height: 1.6;
        }
        .setup-group { margin-bottom: 15px; text-align: left; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #444; }
        select, input[type="date"] { 
            width: 100%; padding: 12px; font-size: 1em; border-radius: 8px; border: 2px solid #ddd; box-sizing: border-box;
        }

        /* é¡Œç›®å€ */
        .q-text { font-size: 1.2em; font-weight: bold; color: var(--text); margin-bottom: 15px; text-align: left; line-height: 1.5; }
        .options-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
        .opt-btn { 
            padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; background: white; 
            cursor: pointer; font-size: 1.05em; text-align: left; transition: 0.2s; 
        }
        .opt-btn.selected { background: var(--main) !important; color: white; border-color: var(--main); }

        /* æŒ‰éˆ• */
        .nav-btns { display: flex; justify-content: space-between; margin-top: 25px; gap: 10px; }
        .action-btn { 
            flex: 1; padding: 12px; font-size: 1.1em; border: none; border-radius: 50px; 
            cursor: pointer; font-weight: bold; transition: 0.3s;
        }
        #start-btn { background: var(--main); color: white; width: 100%; }
        #start-btn:disabled { background: #ccc; }
        .prev-btn { background: #636e72; color: white; }
        .next-btn { background: var(--main); color: white; }
        .submit-btn { background: var(--win); color: white; }

        /* çµç®—èˆ‡å›é¡§ */
        .hidden { display: none; }
        #final-score { font-size: 4em; color: var(--main); margin: 0; }
        .status-msg { margin: 15px 0; font-weight: bold; padding: 12px; border-radius: 8px; }
        .pass { background: #e6fffa; color: var(--win); border: 1px solid var(--win); }
        .fail { background: #fff5f5; color: var(--lose); border: 1px solid var(--lose); }

        #review-area { margin-top: 25px; text-align: left; border-top: 2px solid #eee; padding-top: 20px; }
        .review-item { margin-bottom: 20px; padding: 15px; background: #fcfcfc; border-radius: 10px; border-left: 5px solid #ddd; }
        .review-item.is-correct { border-left-color: var(--win); }
        .review-item.is-wrong { border-left-color: var(--lose); }
        .review-q { font-weight: bold; margin-bottom: 8px; }
        .review-ans { font-size: 0.9em; margin: 4px 0; }
        .text-correct { color: var(--win); font-weight: bold; }
        .text-wrong { color: var(--lose); font-weight: bold; }

        #debug-log { background: #222; color: #00ff00; padding: 8px; font-size: 11px; margin-top: 15px; border-radius: 5px; text-align: left; }
    </style>
</head>
<body>

<div id="game-box">
    <!-- é–‹å§‹ç•«é¢ -->
    <div id="start-screen">
        <h2 style="color: var(--main); margin-top: 0;">å·¥ä½œé …ç›® 02ï¼šä½œæ¥­æº–å‚™</h2>
        <div class="rule-box">
            <strong>ğŸ“ æ¸¬é©—è¦å‰‡èªªæ˜ï¼š</strong><br>
            1. æ¯æ¬¡æ¸¬é©—éš¨æ©ŸæŠ½å– <strong>20 é¡Œ</strong>ï¼Œæ¯é¡Œ <strong>5 åˆ†</strong>ã€‚<br>
            2. æ¸¬é©—ç¸½æ™‚é–“ <strong>20 åˆ†é˜</strong>ã€‚<br>
            3. æˆç¸¾é” <strong>80 åˆ†</strong> ä»¥ä¸Šæ‰æœƒé€å‡ºç´€éŒ„ã€‚<br>
            4. çµæŸå¾Œå¯æŸ¥çœ‹éŒ¯é¡Œèˆ‡æ­£ç¢ºç­”æ¡ˆã€‚
        </div>
        <div class="setup-group">
            <label>æ¸¬è©¦æ—¥æœŸï¼š</label>
            <input type="date" id="quiz-date">
        </div>
        <div class="setup-group">
            <label>é¸æ“‡åº§è™Ÿï¼š</label>
            <select id="player-no"></select>
        </div>
        <button id="start-btn" class="action-btn" onclick="initGame()" disabled>è¼‰å…¥é¡Œåº«ä¸­...</button>
        <div id="debug-log">> ç³»çµ±æº–å‚™ä¸­...</div>
    </div>

    <!-- æ¸¬é©—å€åŸŸ -->
    <div id="quiz-area" class="hidden">
        <div class="info-bar">
            <span id="q-progress">ç¬¬ 1 / 20 é¡Œ</span>
            <span id="timer-text">å‰©é¤˜ 20:00</span>
        </div>
        <div id="q-text" class="q-text"></div>
        <div class="options-grid" id="options-area">
            <button class="opt-btn" onclick="selectOption(1)" id="opt1"></button>
            <button class="opt-btn" onclick="selectOption(2)" id="opt2"></button>
            <button class="opt-btn" onclick="selectOption(3)" id="opt3"></button>
            <button class="opt-btn" onclick="selectOption(4)" id="opt4"></button>
        </div>
        <div class="nav-btns">
            <button class="action-btn prev-btn" id="prev-btn" onclick="moveQuestion(-1)">ä¸Šä¸€é¡Œ</button>
            <button class="action-btn next-btn" id="next-btn" onclick="moveQuestion(1)">ä¸‹ä¸€é¡Œ</button>
            <button class="action-btn submit-btn hidden" id="submit-btn" onclick="confirmSubmit()">æäº¤è€ƒå·</button>
        </div>
    </div>

    <!-- çµç®—ç•«é¢ -->
    <div id="end-screen" class="hidden">
        <h3>æ¸¬é©—çµæŸ</h3>
        <p id="result-info"></p>
        <h1 id="final-score">0</h1><p>åˆ†</p>
        <div id="status-msg" class="status-msg"></div>

        <button class="action-btn next-btn" id="show-review-btn" onclick="toggleReview()">æŸ¥çœ‹é¡Œç›®å›é¡§</button>
        
        <div id="review-area" class="hidden">
            <h4 style="margin-top:0">ğŸ“ é¡Œç›®å›é¡§</h4>
            <div id="review-list"></div>
        </div>

        <div id="rank-box" style="margin-top:20px; text-align:left; background:#f9f9f9; padding:15px; border-radius:10px;">
            <div style="text-align:center; font-weight:bold; color: #555; margin-bottom: 10px;">ğŸ† å…¨ç­å‰äº”å</div>
            <div id="rank-content">è¼‰å…¥ä¸­...</div>
        </div>
        <button class="action-btn prev-btn" style="margin-top:20px;" onclick="location.reload()">è¿”å›é¦–é </button>
    </div>
</div>

<script>
    const SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTaKApjd61Cc4pPeBW3gBknoHdaCkKavZnjSriMPVnWSNx6tbQyksw4fX9DDEo6zlSevqNQ4vvPkqMl/pub?gid=1437660801&single=true&output=csv";
    const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLScOCC3XH910Aj2izzG6Un-9P0y5g8KlbrCDxd1-LvsT1uSRow/formResponse";
    const ID_NO = "entry.380705505";
    const ID_SCORE = "entry.330260248";
    const RANK_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS5zUnJgXdBNUHfIcgtktxutd4Jls3fwf48I9KXK4XNwNMpuXcRXfzNaKjCH35mbHBMwucKSYVKc3w9/pub?output=csv";

    let allQuestions = [], gameQuestions = [], userAnswers = [];
    let currentIdx = 0, totalSeconds = 20 * 60, gameTimer = null;

    // UI åˆå§‹åŒ–
    const sel = document.getElementById('player-no');
    const dateInput = document.getElementById('quiz-date');
    dateInput.value = new Date().toISOString().split('T')[0];
    for(let i=1; i<=36; i++){
        let o = document.createElement('option'); o.value = i; o.textContent = i + " è™Ÿ";
        sel.appendChild(o);
    }

    function log(txt) { document.getElementById('debug-log').innerText = "> " + txt; }

    async function loadData() {
        try {
            const res = await fetch(`${SHEET_CSV}&t=${Date.now()}`);
            const text = await res.text();
            const lines = text.split(/\r?\n/);
            const temp = [];
            lines.forEach((line) => {
                const cols = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/^"|"$/g, '').trim());
                if (cols.length >= 6 && ['1','2','3','4'].includes(cols[1])) {
                    temp.push({ q: cols[0], opts: [cols[2], cols[3], cols[4], cols[5]], a: parseInt(cols[1]) });
                }
            });
            if (temp.length > 0) {
                allQuestions = temp;
                document.getElementById('start-btn').disabled = false;
                document.getElementById('start-btn').innerText = "é–‹å§‹æ¸¬é©—";
                log("å·²è¼‰å…¥ " + allQuestions.length + " é¡Œã€‚");
            }
        } catch (e) { log("è¼‰å…¥å¤±æ•—ï¼š" + e.message); }
    }

    function initGame() {
        if(!sel.value) return alert("è«‹é¸æ“‡åº§è™Ÿ");
        gameQuestions = [...allQuestions].sort(() => Math.random() - 0.5).slice(0, 20);
        userAnswers = new Array(20).fill(null);
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('quiz-area').classList.remove('hidden');
        showQuestion();
        startGlobalTimer();
    }

    function showQuestion() {
        const q = gameQuestions[currentIdx];
        document.getElementById('q-progress').innerText = `ç¬¬ ${currentIdx + 1} / 20 é¡Œ`;
        document.getElementById('q-text').innerText = (currentIdx + 1) + ". " + q.q;
        for(let i=1; i<=4; i++) {
            const btn = document.getElementById('opt' + i);
            btn.innerText = `(${i}) ${q.opts[i-1]}`;
            btn.className = userAnswers[currentIdx] === i ? 'opt-btn selected' : 'opt-btn';
        }
        document.getElementById('prev-btn').style.visibility = (currentIdx === 0) ? 'hidden' : 'visible';
        const isLast = currentIdx === 19;
        document.getElementById('next-btn').classList.toggle('hidden', isLast);
        document.getElementById('submit-btn').classList.toggle('hidden', !isLast);
    }

    function selectOption(val) {
        userAnswers[currentIdx] = val;
        showQuestion();
    }

    function moveQuestion(step) {
        currentIdx += step;
        showQuestion();
    }

    function startGlobalTimer() {
        gameTimer = setInterval(() => {
            totalSeconds--;
            const m = Math.floor(totalSeconds / 60), s = totalSeconds % 60;
            document.getElementById('timer-text').innerText = `å‰©é¤˜ ${m}:${s.toString().padStart(2, '0')}`;
            if (totalSeconds <= 0) { clearInterval(gameTimer); calculateScore(); }
        }, 1000);
    }

    function confirmSubmit() {
        const un = userAnswers.filter(a => a === null).length;
        if (confirm(un > 0 ? `é‚„æœ‰ ${un} é¡Œæœªå¯«ï¼Œç¢ºå®šäº¤å·ï¼Ÿ` : "ç¢ºå®šè¦äº¤å·å—ï¼Ÿ")) calculateScore();
    }

    function calculateScore() {
        clearInterval(gameTimer);
        let correct = 0;
        let reviewHtml = "";

        gameQuestions.forEach((q, i) => {
            const isCorrect = userAnswers[i] === q.a;
            if (isCorrect) correct++;
            
            reviewHtml += `
                <div class="review-item ${isCorrect ? 'is-correct' : 'is-wrong'}">
                    <div class="review-q">${i+1}. ${q.q}</div>
                    <div class="review-ans">æ‚¨çš„ç­”æ¡ˆï¼š<span class="${isCorrect ? 'text-correct' : 'text-wrong'}">(${userAnswers[i] || 'æœªç­”'}) ${userAnswers[i] ? q.opts[userAnswers[i]-1] : ''}</span></div>
                    ${!isCorrect ? `<div class="review-ans">æ­£ç¢ºç­”æ¡ˆï¼š<span class="text-correct">(${q.a}) ${q.opts[q.a-1]}</span></div>` : ''}
                </div>`;
        });

        const score = correct * 5;
        document.getElementById('quiz-area').classList.add('hidden');
        document.getElementById('end-screen').classList.remove('hidden');
        document.getElementById('final-score').innerText = score;
        document.getElementById('result-info').innerText = `${dateInput.value} | ${sel.value}è™Ÿ`;
        document.getElementById('review-list').innerHTML = reviewHtml;

        const status = document.getElementById('status-msg');
        if (score >= 80) {
            status.innerText = "ğŸ‰ é”æ¨™ 80 åˆ†ï¼æˆç¸¾å·²ä¸Šå‚³ã€‚";
            status.className = "status-msg pass";
            fetch(`${FORM_URL}?${ID_NO}=${encodeURIComponent(sel.value)}&${ID_SCORE}=${score}&submit=Submit`, { mode: 'no-cors' });
        } else {
            status.innerText = "âš ï¸ æœªé” 80 åˆ†ï¼Œç´€éŒ„ä¸äºˆé€å‡ºã€‚";
            status.className = "status-msg fail";
        }
        loadRank();
    }

    function toggleReview() {
        const area = document.getElementById('review-area');
        const btn = document.getElementById('show-review-btn');
        const isHidden = area.classList.toggle('hidden');
        btn.innerText = isHidden ? "æŸ¥çœ‹é¡Œç›®å›é¡§" : "éš±è—é¡Œç›®å›é¡§";
        if (!isHidden) area.scrollIntoView({ behavior: 'smooth' });
    }

    async function loadRank() {
        try {
            const res = await fetch(`${RANK_CSV}?t=${Date.now()}`);
            const text = await res.text();
            const lines = text.split(/\r?\n/).slice(1);
            let data = lines.map(l => {
                const c = l.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(item => item.replace(/^"|"$/g, '').trim());
                return { n: c[1], s: parseInt(c[2]) || 0 };
            }).filter(i => i.n).sort((a, b) => b.s - a.s);
            document.getElementById('rank-content').innerHTML = data.slice(0, 5).map((it, i) => `
                <div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom: 1px dashed #ddd;">
                    <span>${i+1}. ${it.n} è™Ÿ</span><span style="color:var(--main); font-weight:bold;">${it.s} åˆ†</span>
                </div>`).join('') || "å°šç„¡è³‡æ–™";
        } catch (e) {}
    }

    window.onload = loadData;
</script>
</body>
</html>
